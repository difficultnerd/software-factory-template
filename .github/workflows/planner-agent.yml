name: Planner Agent

on:
  # Trigger when a spec PR is merged
  pull_request:
    types: [closed]
    paths:
      - 'factory/specs/SPEC-*.md'

jobs:
  generate-plan:
    name: Generate Implementation Plan
    runs-on: ubuntu-latest
    # Only run when PR was merged (not just closed)
    # Branch protection ensures only the repo owner can merge
    if: github.event.pull_request.merged == true
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 2

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Find new/changed spec files
        id: specs
        run: |
          # Find spec files that were added or modified in this merge
          SPEC_FILES=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD -- 'factory/specs/SPEC-*.md' || true)

          if [ -z "$SPEC_FILES" ]; then
            echo "No spec files found in this merge"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Take the first spec file (typically one spec per PR)
          SPEC_FILE=$(echo "$SPEC_FILES" | head -1)
          echo "spec_file=$SPEC_FILE" >> "$GITHUB_OUTPUT"
          echo "found=true" >> "$GITHUB_OUTPUT"

          # Extract spec ID from filename (SPEC-YYYY-N.md -> SPEC-YYYY-N)
          SPEC_ID=$(basename "$SPEC_FILE" .md)
          echo "spec_id=$SPEC_ID" >> "$GITHUB_OUTPUT"

          echo "Found spec: $SPEC_FILE (ID: $SPEC_ID)"

      - name: Generate plan via Claude API
        if: steps.specs.outputs.found == 'true'
        id: plan
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SPEC_FILE: ${{ steps.specs.outputs.spec_file }}
          SPEC_ID: ${{ steps.specs.outputs.spec_id }}
        run: node .github/scripts/planner-agent.mjs

      - name: Create PR with plan
        if: steps.specs.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SPEC_ID: ${{ steps.specs.outputs.spec_id }}
          PLAN_FILE: ${{ steps.plan.outputs.plan_file }}
        run: |
          BRANCH="plan/${SPEC_ID}"

          git config user.name "planner-agent[bot]"
          git config user.email "planner-agent[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add factory/plans/
          git commit -m "plan: generate implementation plan for ${SPEC_ID}

          Spec: ${SPEC_ID}
          Agent: planner-agent (claude-sonnet-4-20250514)
          Status: draft (awaiting human review)"

          git push -u origin "$BRANCH"

          PR_URL=$(gh pr create \
            --title "Plan: ${SPEC_ID}" \
            --body "## Implementation Plan for ${SPEC_ID}

          This plan was generated by the **Planner Agent** from the approved spec.

          ### Review Checklist
          - [ ] Tasks cover all spec requirements
          - [ ] Dependencies are correctly identified
          - [ ] Parallel tasks are safe to run concurrently
          - [ ] Database migrations are complete
          - [ ] No unnecessary middleware modifications
          - [ ] Escalations are reasonable

          ### What Happens Next
          After you merge this plan:
          1. Schema and migration tasks will be created
          2. Contract Test Agent will write tests from the spec
          3. Implementer Agent will write code to pass the tests
          4. Security and Code Review Agents will review the PR

          ---
          *Generated by planner-agent. Review carefully before approving.*" \
            --base main \
            --head "$BRANCH")

          echo "Plan PR created: $PR_URL"

      - name: Handle errors
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SPEC_ID: ${{ steps.specs.outputs.spec_id }}
        run: |
          # Create an issue for the failure
          gh issue create \
            --title "Planner Agent failed for ${SPEC_ID}" \
            --body "The Planner Agent encountered an error generating the implementation plan for ${SPEC_ID}.

          Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          This requires manual investigation." \
            --label "escalation" || true
