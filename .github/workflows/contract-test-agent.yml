name: Contract Test Agent

on:
  # Trigger when a plan PR is merged
  pull_request:
    types: [closed]
    paths:
      - 'factory/plans/PLAN-*.md'

jobs:
  generate-tests:
    name: Generate Contract Tests
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 2

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Find plan and spec files
        id: find
        run: |
          # Find the plan file from this merge
          PLAN_FILE=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD -- 'factory/plans/PLAN-*.md' | head -1)

          if [ -z "$PLAN_FILE" ]; then
            echo "No plan files found in this merge"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "plan_file=$PLAN_FILE" >> "$GITHUB_OUTPUT"
          echo "found=true" >> "$GITHUB_OUTPUT"

          # Extract spec ID from plan filename (PLAN-SPEC-YYYY-N.md -> SPEC-YYYY-N)
          PLAN_BASENAME=$(basename "$PLAN_FILE" .md)
          SPEC_ID=${PLAN_BASENAME#PLAN-}
          echo "spec_id=$SPEC_ID" >> "$GITHUB_OUTPUT"

          SPEC_FILE="factory/specs/${SPEC_ID}.md"
          echo "spec_file=$SPEC_FILE" >> "$GITHUB_OUTPUT"

          echo "Plan: $PLAN_FILE"
          echo "Spec ID: $SPEC_ID"
          echo "Spec file: $SPEC_FILE"

          if [ ! -f "$SPEC_FILE" ]; then
            echo "Warning: Spec file not found at $SPEC_FILE"
          fi

      - name: Generate tests via Claude API
        if: steps.find.outputs.found == 'true'
        id: tests
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SPEC_FILE: ${{ steps.find.outputs.spec_file }}
          PLAN_FILE: ${{ steps.find.outputs.plan_file }}
          SPEC_ID: ${{ steps.find.outputs.spec_id }}
        run: node .github/scripts/contract-test-agent.mjs

      - name: Verify tests compile
        if: steps.find.outputs.found == 'true'
        run: |
          echo "Checking TypeScript compilation..."
          npx tsc --noEmit 2>&1 || echo "Type errors found - will be fixed in PR review"

      - name: Create PR with tests
        if: steps.find.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SPEC_ID: ${{ steps.find.outputs.spec_id }}
          FILES_WRITTEN: ${{ steps.tests.outputs.files_written }}
        run: |
          BRANCH="tests/${SPEC_ID}"

          git config user.name "contract-test-agent[bot]"
          git config user.email "contract-test-agent[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add src/schemas/ tests/contract/ tests/security/
          git commit -m "test: generate contract tests and schemas for ${SPEC_ID}

          Spec: ${SPEC_ID}
          Agent: contract-test-agent (claude-sonnet-4-20250514)
          Files written: ${FILES_WRITTEN}
          Status: tests should FAIL (red phase, no implementation yet)"

          git push -u origin "$BRANCH"

          PR_URL=$(gh pr create \
            --title "Tests: ${SPEC_ID}" \
            --body "## Contract Tests for ${SPEC_ID}

          Generated by the **Contract Test Agent** from the approved spec.

          **These tests are expected to FAIL** because no implementation exists yet. This is the red phase of red-green-refactor.

          ### What Was Generated
          - Zod schemas in \`src/schemas/\` for all data models
          - Contract tests in \`tests/contract/\` for all functional requirements
          - Security tests in \`tests/security/\` for security requirements

          ### Review Checklist
          - [ ] Schemas match the spec's data models
          - [ ] Tests cover all functional requirements (FR-NNN)
          - [ ] Security tests cover all security requirements
          - [ ] Tests use Given/When/Then from spec acceptance criteria
          - [ ] No implementation code is imported (isolation rule)
          - [ ] PII fields are correctly identified in schemas

          ### What Happens Next
          After merge, the Implementer Agent will write code to make these tests pass.

          ---
          *Generated by contract-test-agent. Review carefully before approving.*" \
            --base main \
            --head "$BRANCH")

          echo "Tests PR created: $PR_URL"

      - name: Handle errors
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SPEC_ID: ${{ steps.find.outputs.spec_id }}
        run: |
          gh issue create \
            --title "Contract Test Agent failed for ${SPEC_ID}" \
            --body "The Contract Test Agent encountered an error generating tests for ${SPEC_ID}.

          Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          This requires manual investigation." \
            --label "escalation" || true
